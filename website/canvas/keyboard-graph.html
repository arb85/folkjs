<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Virtual Keyboard Shortcuts</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
      body {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        margin: 0;
        background: #1a1a1a;
        font-family: sans-serif;
      }

      .keyboard {
        background: #2a2a2a;
        padding: 24px;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        display: flex;
        flex-direction: column;
      }

      .keyboard-row {
        display: flex;
        gap: 6px;
        margin-bottom: 6px;
      }

      .keyboard-row:last-child {
        margin-bottom: 0;
      }

      kbd {
        background: #3a3a3a;
        color: #ffffff;
        border: none;
        border-radius: 6px;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.1s ease;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        user-select: none;
      }

      kbd.wide {
        width: 60px;
      }
      kbd.extra-wide {
        width: 86px;
      }
      kbd.space {
        width: 250px;
      }
      kbd.half-height {
        height: 20px;
      }

      kbd:hover {
        background: #4a4a4a;
      }

      kbd.available {
        background: #585e6f;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
      }

      /* Modifier-specific colors */
      kbd.cmd-available,
      kbd.modifier-active[data-modifier='cmd'] {
        background: #00a67e;
      }

      kbd.shift-available,
      kbd.modifier-active[data-modifier='shift'] {
        background: #e63946;
      }

      kbd.alt-available,
      kbd.modifier-active[data-modifier='alt'] {
        background: #4361ee;
      }

      kbd.ctrl-available,
      kbd.modifier-active[data-modifier='ctrl'] {
        background: #9d4edd;
      }

      /* Multi-modifier combinations - Active and Continuation */
      kbd[data-modifier-combo] {
        background: var(--gradient-pattern);
      }

      kbd.continuation-available[data-modifier-combo] {
        --alpha: 0.3;
        background: var(--gradient-pattern);
      }

      /* Define all possible two-modifier combinations */
      kbd[data-modifier-combo='cmd-shift'] {
        --gradient-pattern: repeating-linear-gradient(
          45deg,
          rgba(0, 166, 126, var(--alpha, 1)) 0px,
          rgba(0, 166, 126, var(--alpha, 1)) 8px,
          rgba(230, 57, 70, var(--alpha, 1)) 8px,
          rgba(230, 57, 70, var(--alpha, 1)) 16px
        );
      }

      kbd[data-modifier-combo='cmd-alt'] {
        --gradient-pattern: repeating-linear-gradient(
          45deg,
          rgba(0, 166, 126, var(--alpha, 1)) 0px,
          rgba(0, 166, 126, var(--alpha, 1)) 8px,
          rgba(67, 97, 238, var(--alpha, 1)) 8px,
          rgba(67, 97, 238, var(--alpha, 1)) 16px
        );
      }

      kbd[data-modifier-combo='cmd-ctrl'] {
        --gradient-pattern: repeating-linear-gradient(
          45deg,
          rgba(0, 166, 126, var(--alpha, 1)) 0px,
          rgba(0, 166, 126, var(--alpha, 1)) 8px,
          rgba(157, 78, 221, var(--alpha, 1)) 8px,
          rgba(157, 78, 221, var(--alpha, 1)) 16px
        );
      }

      kbd[data-modifier-combo='shift-alt'] {
        --gradient-pattern: repeating-linear-gradient(
          45deg,
          rgba(230, 57, 70, var(--alpha, 1)) 0px,
          rgba(230, 57, 70, var(--alpha, 1)) 8px,
          rgba(67, 97, 238, var(--alpha, 1)) 8px,
          rgba(67, 97, 238, var(--alpha, 1)) 16px
        );
      }

      kbd[data-modifier-combo='shift-ctrl'] {
        --gradient-pattern: repeating-linear-gradient(
          45deg,
          rgba(230, 57, 70, var(--alpha, 1)) 0px,
          rgba(230, 57, 70, var(--alpha, 1)) 8px,
          rgba(157, 78, 221, var(--alpha, 1)) 8px,
          rgba(157, 78, 221, var(--alpha, 1)) 16px
        );
      }

      kbd[data-modifier-combo='ctrl-shift'] {
        --gradient-pattern: repeating-linear-gradient(
          45deg,
          rgba(157, 78, 221, var(--alpha, 1)) 0px,
          rgba(157, 78, 221, var(--alpha, 1)) 8px,
          rgba(230, 57, 70, var(--alpha, 1)) 8px,
          rgba(230, 57, 70, var(--alpha, 1)) 16px
        );
      }

      kbd[data-modifier-combo='alt-ctrl'] {
        --gradient-pattern: repeating-linear-gradient(
          45deg,
          rgba(67, 97, 238, var(--alpha, 1)) 0px,
          rgba(67, 97, 238, var(--alpha, 1)) 8px,
          rgba(157, 78, 221, var(--alpha, 1)) 8px,
          rgba(157, 78, 221, var(--alpha, 1)) 16px
        );
      }

      .keyboard-arrows {
        display: grid;
        grid-template-columns: repeat(3, 40px);
        grid-template-rows: repeat(2, 20px);
        margin-left: 6px;
      }

      .arrow-up {
        grid-column: 2;
        grid-row: 1;
      }

      .arrow-left {
        grid-column: 1;
        grid-row: 2;
      }

      .arrow-down {
        grid-column: 2;
        grid-row: 2;
      }

      .arrow-right {
        grid-column: 3;
        grid-row: 2;
      }

      .action-tooltip {
        position: absolute;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        pointer-events: none;
        z-index: 1000;
        white-space: nowrap;
      }

      /* View toggle styles */
      .view-toggle {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #3a3a3a;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        font-family: inherit;
        transition: background 0.2s;
      }

      .view-toggle:hover {
        background: #4a4a4a;
      }

      /* Container styles */
      .container {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 100%;
        height: 100vh;
      }

      /* View styles */
      .keyboard-view,
      .dag-view {
        display: none;
      }

      .keyboard-view.active,
      .dag-view.active {
        display: flex;
      }

      /* DAG styles */
      .dag-view {
        width: 800px;
        height: 800px;
        position: relative;
      }

      .dag-container {
        position: absolute;
        width: 100%;
        height: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .dag-view kbd {
        position: absolute;
        transform: translate(-50%, -50%);
        z-index: 1;
        background: #3a3a3a;
        transition: all 0.2s ease;
      }

      .dag-view kbd.context {
        background: #242424;
      }

      .dag-link {
        position: absolute;
        height: 2px;
        background: #4a4a4a;
        transform-origin: 0 50%;
        pointer-events: none;
        z-index: 0;
        transition: all 0.2s ease;
      }

      .dag-link.active {
        background: #6a6a6a;
      }

      .dag-link.partially-active {
        background: #8a8a8a;
      }
    </style>
  </head>
  <body>
    <button class="view-toggle">Toggle View</button>
    <div class="container">
      <div class="keyboard-view active">
        <div class="keyboard">
          <div class="keyboard-row">
            <kbd class="wide">esc</kbd>
            <kbd>f1</kbd>
            <kbd>f2</kbd>
            <kbd>f3</kbd>
            <kbd>f4</kbd>
            <kbd>f5</kbd>
            <kbd>f6</kbd>
            <kbd>f7</kbd>
            <kbd>f8</kbd>
            <kbd>f9</kbd>
            <kbd>f10</kbd>
            <kbd>f11</kbd>
            <kbd>f12</kbd>
            <kbd>•</kbd>
          </div>
          <div class="keyboard-row">
            <kbd>~</kbd>
            <kbd>1</kbd>
            <kbd>2</kbd>
            <kbd>3</kbd>
            <kbd>4</kbd>
            <kbd>5</kbd>
            <kbd>6</kbd>
            <kbd>7</kbd>
            <kbd>8</kbd>
            <kbd>9</kbd>
            <kbd>0</kbd>
            <kbd>-</kbd>
            <kbd>=</kbd>
            <kbd class="wide">⌫</kbd>
          </div>
          <div class="keyboard-row">
            <kbd class="wide">tab</kbd>
            <kbd>q</kbd>
            <kbd>w</kbd>
            <kbd>e</kbd>
            <kbd>r</kbd>
            <kbd>t</kbd>
            <kbd>y</kbd>
            <kbd>u</kbd>
            <kbd>i</kbd>
            <kbd>o</kbd>
            <kbd>p</kbd>
            <kbd>[</kbd>
            <kbd>]</kbd>
            <kbd>\</kbd>
          </div>
          <div class="keyboard-row">
            <kbd class="extra-wide">caps</kbd>
            <kbd>a</kbd>
            <kbd>s</kbd>
            <kbd>d</kbd>
            <kbd>f</kbd>
            <kbd>g</kbd>
            <kbd>h</kbd>
            <kbd>j</kbd>
            <kbd>k</kbd>
            <kbd>l</kbd>
            <kbd>;</kbd>
            <kbd>'</kbd>
            <kbd class="wide">return</kbd>
          </div>
          <div class="keyboard-row">
            <kbd class="wide" data-modifier="shift">⇧</kbd>
            <kbd>`</kbd>
            <kbd>z</kbd>
            <kbd>x</kbd>
            <kbd>c</kbd>
            <kbd>v</kbd>
            <kbd>b</kbd>
            <kbd>n</kbd>
            <kbd>m</kbd>
            <kbd>,</kbd>
            <kbd>.</kbd>
            <kbd>/</kbd>
            <kbd class="extra-wide" data-modifier="shift">⇧</kbd>
          </div>
          <div class="keyboard-row">
            <kbd data-modifier="ctrl">fn</kbd>
            <kbd data-modifier="ctrl">⌃</kbd>
            <kbd data-modifier="alt">⌥</kbd>
            <kbd data-modifier="cmd">⌘</kbd>
            <kbd class="space"></kbd>
            <kbd data-modifier="cmd">⌘</kbd>
            <kbd data-modifier="alt">⌥</kbd>
            <div class="keyboard-arrows">
              <kbd class="half-height arrow-up">↑</kbd>
              <kbd class="half-height arrow-left">←</kbd>
              <kbd class="half-height arrow-down">↓</kbd>
              <kbd class="half-height arrow-right">→</kbd>
            </div>
          </div>
        </div>
      </div>
      <div class="dag-view">
        <div class="dag-container">
          <kbd class="context">ctx</kbd>
        </div>
      </div>
    </div>

    <script>
      // Define keyboard shortcuts
      const shortcuts = {
        // No modifier shortcuts
        f1: { modifiers: [], action: 'Show Help' },
        f2: { modifiers: [], action: 'Rename Symbol' },
        f3: { modifiers: [], action: 'Find Next' },
        f4: { modifiers: [], action: 'Close Tab' },
        f5: { modifiers: [], action: 'Refresh' },
        f6: { modifiers: [], action: 'Focus Address Bar' },
        f7: { modifiers: [], action: 'Caret Browsing' },
        f8: { modifiers: [], action: 'Developer Mode' },
        f9: { modifiers: [], action: 'Toggle Sidebar' },
        f10: { modifiers: [], action: 'Menu Bar' },
        f11: { modifiers: [], action: 'Toggle Full Screen' },
        f12: { modifiers: [], action: 'Developer Tools' },
        esc: { modifiers: [], action: 'Exit / Cancel' },
        tab: { modifiers: [], action: 'Next Field' },
        capslock: { modifiers: [], action: 'Toggle Caps' },
        return: { modifiers: [], action: 'Submit / Enter' },
        backspace: { modifiers: [], action: 'Delete Previous' },
        delete: { modifiers: [], action: 'Delete Forward' },
        home: { modifiers: [], action: 'Start of Line' },
        end: { modifiers: [], action: 'End of Line' },
        pageup: { modifiers: [], action: 'Page Up' },
        pagedown: { modifiers: [], action: 'Page Down' },
        space: { modifiers: [], action: 'Insert Space' },

        // Command shortcuts
        z: { modifiers: ['cmd'], action: 'Undo' },
        z: { modifiers: ['cmd', 'shift'], action: 'Redo' },
        c: { modifiers: ['cmd'], action: 'Copy' },
        v: { modifiers: ['cmd'], action: 'Paste' },
        x: { modifiers: ['cmd'], action: 'Cut' },
        a: { modifiers: ['cmd'], action: 'Select All' },
        s: { modifiers: ['cmd'], action: 'Save' },
        f: { modifiers: ['cmd'], action: 'Find' },
        p: { modifiers: ['cmd'], action: 'Print' },
        n: { modifiers: ['cmd'], action: 'New' },
        w: { modifiers: ['cmd'], action: 'Close' },

        // Shift combinations
        tab: { modifiers: ['shift'], action: 'Focus Previous' },
        space: { modifiers: ['shift'], action: 'Select Text' },
        1: { modifiers: ['shift'], action: 'Insert Exclamation' },
        2: { modifiers: ['shift'], action: 'Insert At Symbol' },
        3: { modifiers: ['shift'], action: 'Insert Hash' },
        4: { modifiers: ['shift'], action: 'Insert Dollar' },

        // Ctrl combinations
        b: { modifiers: ['ctrl'], action: 'Move Back Word' },
        f: { modifiers: ['ctrl'], action: 'Move Forward Word' },
        k: { modifiers: ['ctrl'], action: 'Kill Line' },
        a: { modifiers: ['ctrl'], action: 'Start of Line' },
        e: { modifiers: ['ctrl'], action: 'End of Line' },
        u: { modifiers: ['ctrl'], action: 'Clear Line' },

        // Shift + Ctrl combinations
        r: { modifiers: ['shift', 'ctrl'], action: 'Replace All' },
        t: { modifiers: ['shift', 'ctrl'], action: 'New Terminal' },
        f: { modifiers: ['shift', 'ctrl'], action: 'Format Document' },
        k: { modifiers: ['shift', 'ctrl'], action: 'Delete Line' },
        p: { modifiers: ['shift', 'ctrl'], action: 'Private Browse' },
        n: { modifiers: ['shift', 'ctrl'], action: 'New Window' },

        // Alt combinations
        d: { modifiers: ['alt'], action: 'Duplicate Line' },
        up: { modifiers: ['alt'], action: 'Move Line Up' },
        down: { modifiers: ['alt'], action: 'Move Line Down' },

        // Ctrl + Alt combinations
        b: { modifiers: ['ctrl', 'alt'], action: 'Add Bookmark' },
        l: { modifiers: ['ctrl', 'alt'], action: 'Toggle Line Numbers' },
        t: { modifiers: ['ctrl', 'alt'], action: 'Toggle Theme' },

        // Function keys
        f1: { modifiers: [], action: 'Show Help' },
        f2: { modifiers: [], action: 'Rename Symbol' },
        f3: { modifiers: [], action: 'Find Next' },
        f4: { modifiers: ['alt'], action: 'Close Window' },
        f5: { modifiers: [], action: 'Refresh' },
        f11: { modifiers: [], action: 'Toggle Full Screen' },
        f12: { modifiers: [], action: 'Open Developer Tools' },

        // Navigation
        home: { modifiers: [], action: 'Go to Start of Line' },
        end: { modifiers: [], action: 'Go to End of Line' },
        pageup: { modifiers: [], action: 'Scroll Page Up' },
        pagedown: { modifiers: [], action: 'Scroll Page Down' },

        // Arrow keys with modifiers
        left: { modifiers: ['ctrl'], action: 'Move Word Left' },
        right: { modifiers: ['ctrl'], action: 'Move Word Right' },
        up: { modifiers: ['cmd'], action: 'Scroll Without Moving Cursor' },
        down: { modifiers: ['cmd'], action: 'Scroll Without Moving Cursor' },
      };

      // Track active modifier keys
      const activeModifiers = {
        cmd: false,
        shift: false,
        alt: false,
        ctrl: false,
      };

      // Convert key element text to standardized key name
      function standardizeKeyName(keyText) {
        const mapping = {
          '⌘': 'cmd',
          command: 'cmd',
          '⇧': 'shift',
          '⌥': 'alt',
          option: 'alt',
          '⌃': 'ctrl',
          control: 'ctrl',
        };
        return mapping[keyText.toLowerCase()] || keyText.toLowerCase();
      }

      // Get all available shortcuts for current modifier combination
      function getAvailableShortcuts() {
        const activeModifiersArray = Object.entries(activeModifiers)
          .filter(([_, active]) => active)
          .map(([mod]) => mod);
        const available = new Set();

        Object.entries(shortcuts).forEach(([key, shortcut]) => {
          const modifiers = shortcut.modifiers;
          if (
            modifiers.length === activeModifiersArray.length &&
            modifiers.every((mod) => activeModifiersArray.includes(mod))
          ) {
            available.add(key.toLowerCase());
          }
        });

        return available;
      }

      // Find all valid modifier combinations from shortcuts
      function getValidModifierCombinations() {
        const combinations = new Set();

        // Add combinations from shortcuts only
        Object.values(shortcuts).forEach((shortcut) => {
          const mods = shortcut.modifiers;
          if (mods.length >= 2) {
            for (let i = 0; i < mods.length; i++) {
              for (let j = i + 1; j < mods.length; j++) {
                combinations.add([mods[i], mods[j]].sort().join('-'));
              }
            }
          }
        });
        return combinations;
      }

      // Get possible continuations based on current state
      function getShortcutContinuations() {
        const currentModifiers = new Set(
          Object.entries(activeModifiers)
            .filter(([_, active]) => active)
            .map(([mod]) => mod),
        );

        const validCombinations = getValidModifierCombinations();
        const continuations = new Set();

        // For each modifier
        ['cmd', 'shift', 'alt', 'ctrl'].forEach((mod) => {
          if (!currentModifiers.has(mod)) {
            // Check if this modifier would create a valid combination
            const wouldBeValid =
              currentModifiers.size === 0 ||
              [...currentModifiers].some((existingMod) => {
                const combo = [existingMod, mod].sort().join('-');
                return validCombinations.has(combo);
              });

            if (wouldBeValid) {
              continuations.add(mod);
            }
          }
        });

        return continuations;
      }

      // Update visual state of keyboard
      function updateKeyboardState() {
        const availableShortcuts = getAvailableShortcuts();
        const continuations = getShortcutContinuations();
        const validCombinations = getValidModifierCombinations();

        document.querySelectorAll('kbd').forEach((key) => {
          const keyName = standardizeKeyName(key.textContent);

          // Reset all classes and data attributes
          key.classList.remove('available', 'modifier-active', 'continuation-available');
          key.removeAttribute('data-modifier');
          key.removeAttribute('data-modifier-combo');

          // Handle modifier keys
          if (['cmd', 'shift', 'alt', 'ctrl'].includes(keyName)) {
            const activeModifiersList = Object.entries(activeModifiers)
              .filter(([_, active]) => active)
              .map(([mod]) => mod);

            if (activeModifiers[keyName]) {
              key.classList.add('modifier-active');
              key.dataset.modifier = keyName;

              // Check for active multi-modifier combinations
              activeModifiersList.forEach((otherMod) => {
                if (otherMod !== keyName) {
                  const combo = [keyName, otherMod].sort().join('-');
                  if (validCombinations.has(combo)) {
                    key.dataset.modifierCombo = combo;
                    key.classList.add('modifier-active');
                  }
                }
              });
            }

            // Show continuation possibilities
            if (continuations.has(keyName)) {
              key.classList.add('continuation-available');
              if (activeModifiersList.length === 1) {
                const combo = [activeModifiersList[0], keyName].sort().join('-');
                if (validCombinations.has(combo)) {
                  key.dataset.modifierCombo = combo;
                }
              }
            }
          }

          // Handle regular keys with their modifiers
          if (availableShortcuts.has(keyName)) {
            key.classList.add('available');
            const activeModifiersList = Object.entries(activeModifiers)
              .filter(([_, active]) => active)
              .map(([mod]) => mod)
              .sort();

            // Find matching shortcut
            const shortcut = Object.entries(shortcuts).find(
              ([k, s]) => k === keyName && JSON.stringify(s.modifiers.sort()) === JSON.stringify(activeModifiersList),
            );

            if (shortcut) {
              const [_, { modifiers }] = shortcut;
              if (modifiers.length === 2) {
                key.dataset.modifierCombo = modifiers.sort().join('-');
                key.classList.add('available');
              } else if (modifiers.length === 1) {
                key.dataset.modifier = modifiers[0];
                key.classList.add('available');
              }
            }
          }
        });
      }

      // Add event listeners
      document.querySelectorAll('kbd').forEach((key) => {
        key.addEventListener('click', () => {
          const keyName = standardizeKeyName(key.textContent);
          if (['cmd', 'shift', 'alt', 'ctrl'].includes(keyName)) {
            activeModifiers[keyName] = !activeModifiers[keyName];
            updateKeyboardState();
          }
        });
      });

      // Add keyboard event listeners
      document.addEventListener('keydown', (event) => {
        const key = event.key.toLowerCase();
        if (key === 'meta' || key === 'command') {
          activeModifiers.cmd = true;
        } else if (key === 'shift') {
          activeModifiers.shift = true;
        } else if (key === 'alt') {
          activeModifiers.alt = true;
        } else if (key === 'control') {
          activeModifiers.ctrl = true;
        }
        updateKeyboardState();
        event.preventDefault();
      });

      document.addEventListener('keyup', (event) => {
        const key = event.key.toLowerCase();
        if (key === 'meta' || key === 'command') {
          activeModifiers.cmd = false;
        } else if (key === 'shift') {
          activeModifiers.shift = false;
        } else if (key === 'alt') {
          activeModifiers.alt = false;
        } else if (key === 'control') {
          activeModifiers.ctrl = false;
        }
        updateKeyboardState();
      });

      // Handle tooltip
      let tooltip = null;

      function showTooltip(key, event) {
        const keyName = standardizeKeyName(key.textContent);
        const shortcut = Object.entries(shortcuts).find(
          ([k, s]) =>
            k === keyName &&
            JSON.stringify(s.modifiers.sort()) ===
              JSON.stringify(
                Object.entries(activeModifiers)
                  .filter(([_, active]) => active)
                  .map(([mod]) => mod)
                  .sort(),
              ),
        );

        if (
          shortcut &&
          Object.entries(activeModifiers).filter(([_, active]) => active).length === shortcut[1].modifiers.length &&
          shortcut[1].modifiers.every((mod) =>
            Object.entries(activeModifiers)
              .filter(([_, active]) => active)
              .map(([mod]) => mod)
              .includes(mod),
          )
        ) {
          if (!tooltip) {
            tooltip = document.createElement('div');
            tooltip.className = 'action-tooltip';
            document.body.appendChild(tooltip);
          }

          tooltip.textContent = shortcut[1].action;
          tooltip.style.left = `${event.pageX + 10}px`;
          tooltip.style.top = `${event.pageY + 10}px`;
          tooltip.style.display = 'block';
        }
      }

      function hideTooltip() {
        if (tooltip) {
          tooltip.style.display = 'none';
        }
      }

      document.querySelectorAll('kbd').forEach((key) => {
        key.addEventListener('mouseover', (e) => showTooltip(key, e));
        key.addEventListener('mouseout', hideTooltip);
      });

      function createDagNode(type, label, modifiers = [], angle, level) {
        const node = document.createElement('kbd');
        node.textContent = label;

        if (modifiers.length > 1) {
          node.setAttribute('data-modifier-combo', modifiers.join('-'));
        } else if (modifiers.length === 1) {
          node.setAttribute('data-modifier', modifiers[0]);
        } else if (type === 'context') {
          node.className = 'context';
        }

        // Store modifiers and type for activation logic
        if (modifiers.length > 0) {
          node.setAttribute('data-modifiers', JSON.stringify(modifiers));
        }
        node.setAttribute('data-node-type', type);

        const radius = level * 100;
        const x = Math.cos(angle) * radius + 400;
        const y = Math.sin(angle) * radius + 400;

        node.style.left = `${x}px`;
        node.style.top = `${y}px`;

        return { node, x, y };
      }

      function createDagLink(x1, y1, x2, y2, modifiers = []) {
        const link = document.createElement('div');
        link.className = 'dag-link';
        if (modifiers.length > 0) {
          link.setAttribute('data-modifiers', JSON.stringify(modifiers));
        }

        const dx = x2 - x1;
        const dy = y2 - y1;
        const length = Math.sqrt(dx * dx + dy * dy);
        const angle = (Math.atan2(dy, dx) * 180) / Math.PI;

        link.style.width = `${length}px`;
        link.style.left = `${x1}px`;
        link.style.top = `${y1}px`;
        link.style.transform = `rotate(${angle}deg)`;

        return link;
      }

      function getModifierColor(modifier) {
        const colors = {
          cmd: '#00a67e',
          shift: '#e63946',
          alt: '#4361ee',
          ctrl: '#9d4edd',
        };
        return colors[modifier];
      }

      function updateDagView() {
        const container = document.querySelector('.dag-view .dag-container');
        container.innerHTML = '';

        // First pass: analyze which modifiers and combos are actually used
        const usedModifiers = new Set();
        const usedCombos = new Set();

        Object.values(shortcuts).forEach((data) => {
          if (data.modifiers.length === 1) {
            usedModifiers.add(data.modifiers[0]);
          } else if (data.modifiers.length > 1) {
            usedModifiers.add(data.modifiers[0]);
            usedModifiers.add(data.modifiers[1]);
            usedCombos.add(data.modifiers.join('-'));
          }
        });

        // Add context node
        const contextNode = createDagNode('context', 'ctx', [], 0, 0);
        container.appendChild(contextNode.node);

        // Add only used modifier nodes
        const modifiers = Array.from(usedModifiers);
        const modifierNodes = {};
        const modifierAngles = {};

        modifiers.forEach((mod, i) => {
          const angle = (i / modifiers.length) * 2 * Math.PI;
          modifierAngles[mod] = angle;
          const node = createDagNode('modifier', mod, [mod], angle, 1);
          container.appendChild(node.node);
          modifierNodes[mod] = node;

          container.appendChild(createDagLink(400, 400, node.x, node.y, [mod]));
        });

        // Group actions by their parent (modifier or combo)
        const actionsByParent = {};
        Object.entries(shortcuts).forEach(([key, data]) => {
          if (data.modifiers.length > 0) {
            const parentKey = data.modifiers.join('-');
            if (!actionsByParent[parentKey]) {
              actionsByParent[parentKey] = [];
            }
            actionsByParent[parentKey].push({ key, data });
          }
        });

        // Add only combos that have actions
        const comboNodes = {};
        Array.from(usedCombos).forEach((comboKey) => {
          const combo = comboKey.split('-');
          let angle1 = modifierAngles[combo[0]];
          let angle2 = modifierAngles[combo[1]];

          if (Math.abs(angle1 - angle2) > Math.PI) {
            if (angle1 > angle2) {
              angle2 += 2 * Math.PI;
            } else {
              angle1 += 2 * Math.PI;
            }
          }

          const avgAngle = (angle1 + angle2) / 2;
          const node = createDagNode('combo', combo.join('+'), combo, avgAngle, 2);
          container.appendChild(node.node);
          comboNodes[comboKey] = node;

          combo.forEach((mod) => {
            const modNode = modifierNodes[mod];
            container.appendChild(createDagLink(modNode.x, modNode.y, node.x, node.y, combo));
          });
        });

        // Add action nodes with even distribution
        Object.entries(actionsByParent).forEach(([parentKey, actions]) => {
          const parentNode = parentKey.includes('-') ? comboNodes[parentKey] : modifierNodes[parentKey];
          if (parentNode) {
            const baseAngle = Math.atan2(parentNode.y - 400, parentNode.x - 400);
            const angleStep = Math.PI / 3 / Math.max(actions.length, 1); // 60-degree arc

            actions.forEach(({ key, data }, i) => {
              const offset = angleStep * (i - (actions.length - 1) / 2);
              const node = createDagNode('action', key, data.modifiers, baseAngle + offset, data.modifiers.length + 2);
              container.appendChild(node.node);
              container.appendChild(createDagLink(parentNode.x, parentNode.y, node.x, node.y, data.modifiers));
            });
          }
        });
      }

      function updateActivation(activeModifiers) {
        // Reset all nodes and links to inactive state
        document.querySelectorAll('.dag-view kbd').forEach((el) => {
          if (el.hasAttribute('data-modifier') || el.hasAttribute('data-modifiers')) {
            el.style.background = '#3a3a3a';
          }
        });
        document.querySelectorAll('.dag-link').forEach((link) => {
          link.classList.remove('active');
          link.classList.remove('partially-active');
        });

        if (activeModifiers.length > 0) {
          // First activate single modifiers
          activeModifiers.forEach((mod) => {
            const node = document.querySelector(`.dag-view kbd[data-modifier="${mod}"]`);
            if (node) {
              node.style.background = getModifierColor(mod);
            }
          });

          // Then handle combinations and their children
          document.querySelectorAll('.dag-view kbd[data-modifiers]').forEach((node) => {
            const nodeModifiers = JSON.parse(node.getAttribute('data-modifiers'));
            const isFullyActive = nodeModifiers.every((mod) => activeModifiers.includes(mod));
            const isPartiallyActive = nodeModifiers.some((mod) => activeModifiers.includes(mod));
            const nodeType = node.getAttribute('data-node-type');
            const isLeafNode = nodeType === 'action';

            if (isFullyActive) {
              if (nodeModifiers.length > 1) {
                // For nodes with multiple modifiers, use gradient
                const pattern = `repeating-linear-gradient(45deg, 
                  ${getModifierColor(nodeModifiers[0])} 0px, 
                  ${getModifierColor(nodeModifiers[0])} 8px, 
                  ${getModifierColor(nodeModifiers[1])} 8px, 
                  ${getModifierColor(nodeModifiers[1])} 16px)`;
                node.style.background = pattern;
              } else {
                // For single modifier nodes, use solid color
                node.style.background = getModifierColor(nodeModifiers[0]);
              }
            } else if (isPartiallyActive && !isLeafNode) {
              // Only show dimmed color for non-leaf nodes that are partially active
              const activeModifier = nodeModifiers.find((mod) => activeModifiers.includes(mod));
              const color = getModifierColor(activeModifier);
              // Convert color to RGBA with 0.3 opacity for dimming
              const dimmedColor = color.replace('rgb', 'rgba').replace(')', ', 0.3)');
              node.style.background = dimmedColor;
            } else {
              node.style.background = '#3a3a3a';
            }
          });

          // Activate relevant links
          document.querySelectorAll('.dag-link[data-modifiers]').forEach((link) => {
            const linkModifiers = JSON.parse(link.getAttribute('data-modifiers'));
            const isActive = linkModifiers.every((mod) => activeModifiers.includes(mod));
            const isPartiallyActive = linkModifiers.some((mod) => activeModifiers.includes(mod));
            if (isActive) {
              link.classList.add('active');
            } else if (isPartiallyActive) {
              link.classList.add('partially-active');
            }
          });
        }
      }

      function getActiveModifiers() {
        return Object.entries(activeModifiers)
          .filter(([_, active]) => active)
          .map(([mod]) => mod);
      }

      // Hook up the activation logic to the existing keyboard events
      document.addEventListener('keydown', (e) => {
        console.log('Keydown:', e.key);
        const key = e.key.toLowerCase();
        // Map common key names to our modifier names
        const modMap = {
          control: 'ctrl',
          meta: 'cmd',
          alt: 'alt',
          shift: 'shift',
        };
        const mod = modMap[key];
        console.log('Mapped to modifier:', mod);
        if (mod && !activeModifiers.includes(mod)) {
          activeModifiers.push(mod);
          updateKeyboardState();
          updateActivation(activeModifiers);
        }
      });

      document.addEventListener('keyup', (e) => {
        const key = e.key.toLowerCase();
        const modMap = {
          control: 'ctrl',
          meta: 'cmd',
          alt: 'alt',
          shift: 'shift',
        };
        const mod = modMap[key];
        if (mod) {
          const index = activeModifiers.indexOf(mod);
          if (index > -1) {
            activeModifiers.splice(index, 1);
            updateKeyboardState();
            updateActivation(activeModifiers);
          }
        }
      });

      // Handle clicks on modifier keys
      document.querySelectorAll('kbd[data-modifier]').forEach((key) => {
        key.addEventListener('click', () => {
          const mod = key.getAttribute('data-modifier');
          const index = activeModifiers.indexOf(mod);
          if (index === -1) {
            activeModifiers.push(mod);
          } else {
            activeModifiers.splice(index, 1);
          }
          updateKeyboardState();
          updateActivation(activeModifiers);
        });
      });

      // Toggle view functionality
      const toggleButton = document.querySelector('.view-toggle');
      const keyboardView = document.querySelector('.keyboard-view');
      const dagView = document.querySelector('.dag-view');

      toggleButton.addEventListener('click', () => {
        keyboardView.classList.toggle('active');
        dagView.classList.toggle('active');
        if (dagView.classList.contains('active')) {
          updateDagView();
        }
      });

      // Initial keyboard state update
      updateKeyboardState();
    </script>
  </body>
</html>
