<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Virtual Keyboard Shortcuts</title>
    <style>
      body {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        margin: 0;
        background: #1a1a1a;
        font-family: sans-serif;
      }

      .keyboard {
        background: #2a2a2a;
        padding: 24px;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        display: flex;
        flex-direction: column;
      }

      .keyboard-row {
        display: flex;
        gap: 6px;
        margin-bottom: 6px;
      }

      .keyboard-row:last-child {
        margin-bottom: 0;
      }

      kbd {
        background: #3a3a3a;
        color: #ffffff;
        border: none;
        border-radius: 6px;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.1s ease;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        user-select: none;
      }

      kbd.wide {
        width: 60px;
      }
      kbd.extra-wide {
        width: 86px;
      }
      kbd.space {
        width: 250px;
      }
      kbd.half-height {
        height: 20px;
      }

      kbd:hover {
        background: #4a4a4a;
      }

      kbd.available {
        background: #585e6f;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
      }

      /* Modifier-specific colors */
      kbd.cmd-available,
      kbd.modifier-active[data-modifier='cmd'] {
        background: #00a67e;
      }

      kbd.shift-available,
      kbd.modifier-active[data-modifier='shift'] {
        background: #e63946;
      }

      kbd.alt-available,
      kbd.modifier-active[data-modifier='alt'] {
        background: #4361ee;
      }

      kbd.ctrl-available,
      kbd.modifier-active[data-modifier='ctrl'] {
        background: #9d4edd;
      }

      /* Multi-modifier combinations - Active and Continuation */
      kbd[data-modifier-combo] {
        background: var(--gradient-pattern);
      }

      kbd.continuation-available[data-modifier-combo] {
        --alpha: 0.3;
        background: var(--gradient-pattern);
      }

      /* Define all possible two-modifier combinations */
      kbd[data-modifier-combo='cmd-shift'] {
        --gradient-pattern: repeating-linear-gradient(
          45deg,
          rgba(0, 166, 126, var(--alpha, 1)) 0px,
          rgba(0, 166, 126, var(--alpha, 1)) 8px,
          rgba(230, 57, 70, var(--alpha, 1)) 8px,
          rgba(230, 57, 70, var(--alpha, 1)) 16px
        );
      }

      kbd[data-modifier-combo='cmd-alt'] {
        --gradient-pattern: repeating-linear-gradient(
          45deg,
          rgba(0, 166, 126, var(--alpha, 1)) 0px,
          rgba(0, 166, 126, var(--alpha, 1)) 8px,
          rgba(67, 97, 238, var(--alpha, 1)) 8px,
          rgba(67, 97, 238, var(--alpha, 1)) 16px
        );
      }

      kbd[data-modifier-combo='cmd-ctrl'] {
        --gradient-pattern: repeating-linear-gradient(
          45deg,
          rgba(0, 166, 126, var(--alpha, 1)) 0px,
          rgba(0, 166, 126, var(--alpha, 1)) 8px,
          rgba(157, 78, 221, var(--alpha, 1)) 8px,
          rgba(157, 78, 221, var(--alpha, 1)) 16px
        );
      }

      kbd[data-modifier-combo='shift-alt'] {
        --gradient-pattern: repeating-linear-gradient(
          45deg,
          rgba(230, 57, 70, var(--alpha, 1)) 0px,
          rgba(230, 57, 70, var(--alpha, 1)) 8px,
          rgba(67, 97, 238, var(--alpha, 1)) 8px,
          rgba(67, 97, 238, var(--alpha, 1)) 16px
        );
      }

      kbd[data-modifier-combo='shift-ctrl'] {
        --gradient-pattern: repeating-linear-gradient(
          45deg,
          rgba(230, 57, 70, var(--alpha, 1)) 0px,
          rgba(230, 57, 70, var(--alpha, 1)) 8px,
          rgba(157, 78, 221, var(--alpha, 1)) 8px,
          rgba(157, 78, 221, var(--alpha, 1)) 16px
        );
      }

      kbd[data-modifier-combo='ctrl-shift'] {
        --gradient-pattern: repeating-linear-gradient(
          45deg,
          rgba(157, 78, 221, var(--alpha, 1)) 0px,
          rgba(157, 78, 221, var(--alpha, 1)) 8px,
          rgba(230, 57, 70, var(--alpha, 1)) 8px,
          rgba(230, 57, 70, var(--alpha, 1)) 16px
        );
      }

      kbd[data-modifier-combo='alt-ctrl'] {
        --gradient-pattern: repeating-linear-gradient(
          45deg,
          rgba(67, 97, 238, var(--alpha, 1)) 0px,
          rgba(67, 97, 238, var(--alpha, 1)) 8px,
          rgba(157, 78, 221, var(--alpha, 1)) 8px,
          rgba(157, 78, 221, var(--alpha, 1)) 16px
        );
      }

      .keyboard-arrows {
        display: grid;
        grid-template-columns: repeat(3, 40px);
        grid-template-rows: repeat(2, 20px);
        margin-left: 6px;
      }

      .arrow-up {
        grid-column: 2;
        grid-row: 1;
      }

      .arrow-left {
        grid-column: 1;
        grid-row: 2;
      }

      .arrow-down {
        grid-column: 2;
        grid-row: 2;
      }

      .arrow-right {
        grid-column: 3;
        grid-row: 2;
      }

      .action-tooltip {
        position: absolute;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        pointer-events: none;
        z-index: 1000;
        white-space: nowrap;
      }

      /* View toggle styles */
      .view-toggle {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #3a3a3a;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        font-family: inherit;
        transition: background 0.2s;
      }

      .view-toggle:hover {
        background: #4a4a4a;
      }

      /* Container styles */
      .container {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 100%;
        height: 100vh;
      }

      /* View styles */
      .keyboard-view,
      .dag-view {
        display: none;
      }

      .keyboard-view.active,
      .dag-view.active {
        display: flex;
      }

      /* DAG styles */
      .dag-view {
        width: 800px;
        height: 800px;
        position: relative;
      }

      .dag-container {
        position: absolute;
        width: 100%;
        height: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .dag-view kbd {
        position: absolute;
        transform: translate(-50%, -50%);
        z-index: 1;
        background: #3a3a3a;
        transition: all 0.2s ease;
      }

      .dag-view kbd.context {
        background: #242424;
      }

      .dag-link {
        position: absolute;
        height: 2px;
        background: #4a4a4a;
        transform-origin: 0 50%;
        pointer-events: none;
        z-index: 0;
        transition: all 0.2s ease;
      }

      .dag-link.active {
        height: 3px;
      }

      .dag-link.partially-active {
        height: 2.5px;
      }
    </style>
  </head>
  <body>
    <button class="view-toggle">Toggle View</button>
    <div class="container">
      <div class="keyboard-view active">
        <div class="keyboard">
          <div class="keyboard-row">
            <kbd class="wide">esc</kbd>
            <kbd>f1</kbd>
            <kbd>f2</kbd>
            <kbd>f3</kbd>
            <kbd>f4</kbd>
            <kbd>f5</kbd>
            <kbd>f6</kbd>
            <kbd>f7</kbd>
            <kbd>f8</kbd>
            <kbd>f9</kbd>
            <kbd>f10</kbd>
            <kbd>f11</kbd>
            <kbd>f12</kbd>
            <kbd>•</kbd>
          </div>
          <div class="keyboard-row">
            <kbd>~</kbd>
            <kbd>1</kbd>
            <kbd>2</kbd>
            <kbd>3</kbd>
            <kbd>4</kbd>
            <kbd>5</kbd>
            <kbd>6</kbd>
            <kbd>7</kbd>
            <kbd>8</kbd>
            <kbd>9</kbd>
            <kbd>0</kbd>
            <kbd>-</kbd>
            <kbd>=</kbd>
            <kbd class="wide">⌫</kbd>
          </div>
          <div class="keyboard-row">
            <kbd class="wide">tab</kbd>
            <kbd>q</kbd>
            <kbd>w</kbd>
            <kbd>e</kbd>
            <kbd>r</kbd>
            <kbd>t</kbd>
            <kbd>y</kbd>
            <kbd>u</kbd>
            <kbd>i</kbd>
            <kbd>o</kbd>
            <kbd>p</kbd>
            <kbd>[</kbd>
            <kbd>]</kbd>
            <kbd>\</kbd>
          </div>
          <div class="keyboard-row">
            <kbd class="extra-wide">caps</kbd>
            <kbd>a</kbd>
            <kbd>s</kbd>
            <kbd>d</kbd>
            <kbd>f</kbd>
            <kbd>g</kbd>
            <kbd>h</kbd>
            <kbd>j</kbd>
            <kbd>k</kbd>
            <kbd>l</kbd>
            <kbd>;</kbd>
            <kbd>'</kbd>
            <kbd class="wide">return</kbd>
          </div>
          <div class="keyboard-row">
            <kbd class="wide" data-modifier="shift">⇧</kbd>
            <kbd>`</kbd>
            <kbd>z</kbd>
            <kbd>x</kbd>
            <kbd>c</kbd>
            <kbd>v</kbd>
            <kbd>b</kbd>
            <kbd>n</kbd>
            <kbd>m</kbd>
            <kbd>,</kbd>
            <kbd>.</kbd>
            <kbd>/</kbd>
            <kbd class="extra-wide" data-modifier="shift">⇧</kbd>
          </div>
          <div class="keyboard-row">
            <kbd data-modifier="ctrl">fn</kbd>
            <kbd data-modifier="ctrl">⌃</kbd>
            <kbd data-modifier="alt">⌥</kbd>
            <kbd data-modifier="cmd">⌘</kbd>
            <kbd class="space"></kbd>
            <kbd data-modifier="cmd">⌘</kbd>
            <kbd data-modifier="alt">⌥</kbd>
            <div class="keyboard-arrows">
              <kbd class="half-height arrow-up">↑</kbd>
              <kbd class="half-height arrow-left">←</kbd>
              <kbd class="half-height arrow-down">↓</kbd>
              <kbd class="half-height arrow-right">→</kbd>
            </div>
          </div>
        </div>
      </div>
      <div class="dag-view">
        <div class="dag-container">
          <kbd class="context">ctx</kbd>
        </div>
      </div>
    </div>

    <script>
      // Define keyboard shortcuts
      const shortcuts = {
        // No modifier shortcuts
        f1: { modifiers: [], action: 'Show Help' },
        f2: { modifiers: [], action: 'Rename Symbol' },
        f3: { modifiers: [], action: 'Find Next' },
        f4: { modifiers: [], action: 'Close Tab' },
        f5: { modifiers: [], action: 'Refresh' },
        f6: { modifiers: [], action: 'Focus Address Bar' },
        f7: { modifiers: [], action: 'Caret Browsing' },
        f8: { modifiers: [], action: 'Developer Mode' },
        f9: { modifiers: [], action: 'Toggle Sidebar' },
        f10: { modifiers: [], action: 'Menu Bar' },
        f11: { modifiers: [], action: 'Toggle Full Screen' },
        f12: { modifiers: [], action: 'Developer Tools' },
        esc: { modifiers: [], action: 'Exit / Cancel' },

        // Command shortcuts
        z: { modifiers: ['cmd'], action: 'Undo' },
        z: { modifiers: ['cmd', 'shift'], action: 'Redo' },
        c: { modifiers: ['cmd'], action: 'Copy' },
        v: { modifiers: ['cmd'], action: 'Paste' },
        x: { modifiers: ['cmd'], action: 'Cut' },
        a: { modifiers: ['cmd'], action: 'Select All' },
        s: { modifiers: ['cmd'], action: 'Save' },
        f: { modifiers: ['cmd'], action: 'Find' },
        p: { modifiers: ['cmd'], action: 'Print' },
        n: { modifiers: ['cmd'], action: 'New' },
        w: { modifiers: ['cmd'], action: 'Close' },

        // Shift combinations
        tab: { modifiers: ['shift'], action: 'Focus Previous' },
        space: { modifiers: ['shift'], action: 'Select Text' },
        1: { modifiers: ['shift'], action: 'Insert Exclamation' },
        2: { modifiers: ['shift'], action: 'Insert At Symbol' },
        3: { modifiers: ['shift'], action: 'Insert Hash' },
        4: { modifiers: ['shift'], action: 'Insert Dollar' },

        // Ctrl combinations
        b: { modifiers: ['ctrl'], action: 'Move Back Word' },
        f: { modifiers: ['ctrl'], action: 'Move Forward Word' },
        k: { modifiers: ['ctrl'], action: 'Kill Line' },
        a: { modifiers: ['ctrl'], action: 'Start of Line' },
        e: { modifiers: ['ctrl'], action: 'End of Line' },
        u: { modifiers: ['ctrl'], action: 'Clear Line' },

        // Shift + Ctrl combinations
        r: { modifiers: ['shift', 'ctrl'], action: 'Replace All' },
        t: { modifiers: ['shift', 'ctrl'], action: 'New Terminal' },
        f: { modifiers: ['shift', 'ctrl'], action: 'Format Document' },
        k: { modifiers: ['shift', 'ctrl'], action: 'Delete Line' },
        p: { modifiers: ['shift', 'ctrl'], action: 'Private Browse' },
        n: { modifiers: ['shift', 'ctrl'], action: 'New Window' },

        // Alt combinations
        d: { modifiers: ['alt'], action: 'Duplicate Line' },
        up: { modifiers: ['alt'], action: 'Move Line Up' },
        down: { modifiers: ['alt'], action: 'Move Line Down' },

        // Ctrl + Alt combinations
        b: { modifiers: ['ctrl', 'alt'], action: 'Add Bookmark' },
        l: { modifiers: ['ctrl', 'alt'], action: 'Toggle Line Numbers' },
        t: { modifiers: ['ctrl', 'alt'], action: 'Toggle Theme' },

        // Function keys
        f1: { modifiers: [], action: 'Show Help' },
        f2: { modifiers: [], action: 'Rename Symbol' },
        f3: { modifiers: [], action: 'Find Next' },
        f4: { modifiers: ['alt'], action: 'Close Window' },
        f5: { modifiers: [], action: 'Refresh' },
        f11: { modifiers: [], action: 'Toggle Full Screen' },
        f12: { modifiers: [], action: 'Open Developer Tools' },

        // Arrow keys with modifiers
        left: { modifiers: ['ctrl'], action: 'Move Word Left' },
        right: { modifiers: ['ctrl'], action: 'Move Word Right' },
        up: { modifiers: ['cmd'], action: 'Scroll Without Moving Cursor' },
        down: { modifiers: ['cmd'], action: 'Scroll Without Moving Cursor' },
      };

      // Track active modifier keys
      const activeModifiers = {
        cmd: false,
        shift: false,
        alt: false,
        ctrl: false,
      };

      // Convert key element text to standardized key name
      function standardizeKeyName(keyText) {
        const mapping = {
          '⌘': 'cmd',
          command: 'cmd',
          '⇧': 'shift',
          '⌥': 'alt',
          option: 'alt',
          '⌃': 'ctrl',
          control: 'ctrl',
        };
        return mapping[keyText.toLowerCase()] || keyText.toLowerCase();
      }

      // Get all available shortcuts for current modifier combination
      function getAvailableShortcuts() {
        const activeModifiersArray = Object.entries(activeModifiers)
          .filter(([_, active]) => active)
          .map(([mod]) => mod);
        const available = new Set();

        Object.entries(shortcuts).forEach(([key, shortcut]) => {
          const modifiers = shortcut.modifiers;
          if (
            modifiers.length === activeModifiersArray.length &&
            modifiers.every((mod) => activeModifiersArray.includes(mod))
          ) {
            available.add(key.toLowerCase());
          }
        });

        return available;
      }

      // Find all valid modifier combinations from shortcuts
      function getValidModifierCombinations() {
        const combinations = new Set();

        // Add combinations from shortcuts only
        Object.values(shortcuts).forEach((shortcut) => {
          const mods = shortcut.modifiers;
          if (mods.length >= 2) {
            for (let i = 0; i < mods.length; i++) {
              for (let j = i + 1; j < mods.length; j++) {
                combinations.add([mods[i], mods[j]].sort().join('-'));
              }
            }
          }
        });
        return combinations;
      }

      // Get possible continuations based on current state
      function getShortcutContinuations() {
        const currentModifiers = new Set(
          Object.entries(activeModifiers)
            .filter(([_, active]) => active)
            .map(([mod]) => mod),
        );

        const validCombinations = getValidModifierCombinations();
        const continuations = new Set();

        // For each modifier
        ['cmd', 'shift', 'alt', 'ctrl'].forEach((mod) => {
          if (!currentModifiers.has(mod)) {
            // Check if this modifier would create a valid combination
            const wouldBeValid =
              currentModifiers.size === 0 ||
              [...currentModifiers].some((existingMod) => {
                const combo = [existingMod, mod].sort().join('-');
                return validCombinations.has(combo);
              });

            if (wouldBeValid) {
              continuations.add(mod);
            }
          }
        });

        return continuations;
      }

      // Updated applyModifierStyles function
      function applyModifierStyles(element, modifiers, isActive = true, isPartiallyActive = false, isValid = false) {
        // Reset to default state - non-colored state for inactive keys
        element.style.background = '#3a3a3a';

        // For modifier keys when not pressed, show very dimmed color
        if (element.hasAttribute('data-modifier') && !isActive && !isPartiallyActive) {
          if (isValid) {
            const modifier = element.getAttribute('data-modifier');
            const color = getModifierColor(modifier);
            element.style.background = color.replace('rgb', 'rgba').replace(')', ', 0.2)');
          }
          return;
        }

        // If not active or partially active and not valid, keep default color
        if (!isActive && !isPartiallyActive && !isValid) {
          return;
        }

        // Apply dimmed style for valid but inactive nodes
        if (!isActive && !isPartiallyActive && isValid) {
          if (modifiers.length === 0) {
            element.style.background = 'rgba(88, 94, 111, 0.3)'; // Dimmed version of #585e6f
          } else if (modifiers.length === 1) {
            const color = getModifierColor(modifiers[0]);
            element.style.background = color.replace('rgb', 'rgba').replace(')', ', 0.2)');
          } else if (modifiers.length === 2) {
            const color1 = getModifierColor(modifiers[0]).replace('rgb', 'rgba').replace(')', ', 0.2)');
            const color2 = getModifierColor(modifiers[1]).replace('rgb', 'rgba').replace(')', ', 0.2)');
            const pattern = `repeating-linear-gradient(45deg,
              ${color1} 0px,
              ${color1} 8px,
              ${color2} 8px,
              ${color2} 16px
            )`;
            element.style.background = pattern;
          }
          return;
        }

        // Apply full color only for active nodes
        if (isActive) {
          if (modifiers.length === 0) {
            element.style.background = '#585e6f';
          } else if (modifiers.length === 1) {
            element.style.background = getModifierColor(modifiers[0]);
          } else if (modifiers.length === 2) {
            const pattern = `repeating-linear-gradient(45deg,
              ${getModifierColor(modifiers[0])} 0px,
              ${getModifierColor(modifiers[0])} 8px,
              ${getModifierColor(modifiers[1])} 8px,
              ${getModifierColor(modifiers[1])} 16px
            )`;
            element.style.background = pattern;
          }
        }
        // Apply partially active style
        else if (isPartiallyActive) {
          if (modifiers.length === 1) {
            const color = getModifierColor(modifiers[0]);
            element.style.background = color.replace('rgb', 'rgba').replace(')', ', 0.3)');
          } else if (modifiers.length === 2) {
            const pattern = `repeating-linear-gradient(45deg,
              ${getModifierColor(modifiers[0]).replace('rgb', 'rgba').replace(')', ', 0.3)')} 0px,
              ${getModifierColor(modifiers[0]).replace('rgb', 'rgba').replace(')', ', 0.3)')} 8px,
              ${getModifierColor(modifiers[1]).replace('rgb', 'rgba').replace(')', ', 0.3)')} 8px,
              ${getModifierColor(modifiers[1]).replace('rgb', 'rgba').replace(')', ', 0.3)')} 16px
            )`;
            element.style.background = pattern;
          }
        }
      }

      // Update the keyboard state function
      function updateKeyboardState() {
        const availableShortcuts = getAvailableShortcuts();
        const continuations = getShortcutContinuations();

        document.querySelectorAll('kbd').forEach((key) => {
          const keyName = standardizeKeyName(key.textContent);

          // Handle modifier keys
          if (['cmd', 'shift', 'alt', 'ctrl'].includes(keyName)) {
            if (activeModifiers[keyName]) {
              applyModifierStyles(key, [keyName], true, false);
            } else {
              // Always apply dimmed style to modifier keys when not active
              applyModifierStyles(key, [keyName], false, false);
            }
            return;
          }

          // Handle regular keys
          if (availableShortcuts.has(keyName)) {
            const activeModifiersList = Object.entries(activeModifiers)
              .filter(([_, active]) => active)
              .map(([mod]) => mod)
              .sort();

            const shortcut = Object.entries(shortcuts).find(
              ([k, s]) => k === keyName && JSON.stringify(s.modifiers.sort()) === JSON.stringify(activeModifiersList),
            );

            if (shortcut) {
              applyModifierStyles(key, shortcut[1].modifiers, true, false);
            } else {
              key.style.background = '#3a3a3a';
            }
          } else {
            key.style.background = '#3a3a3a';
          }
        });
      }

      // Add event listeners
      document.querySelectorAll('kbd').forEach((key) => {
        key.addEventListener('click', () => {
          const keyName = standardizeKeyName(key.textContent);
          if (['cmd', 'shift', 'alt', 'ctrl'].includes(keyName)) {
            activeModifiers[keyName] = !activeModifiers[keyName];
            updateKeyboardState();
          }
        });
      });

      // Add keyboard event listeners
      document.addEventListener('keydown', (e) => {
        console.log('Keydown:', e.key);
        const key = e.key.toLowerCase();
        // Map common key names to our modifier names
        const modMap = {
          control: 'ctrl',
          meta: 'cmd',
          alt: 'alt',
          shift: 'shift',
        };
        const mod = modMap[key];
        console.log('Mapped to modifier:', mod);
        if (mod) {
          activeModifiers[mod] = true;
          updateKeyboardState();
          updateActivation();
        }
      });

      document.addEventListener('keyup', (e) => {
        const key = e.key.toLowerCase();
        const modMap = {
          control: 'ctrl',
          meta: 'cmd',
          alt: 'alt',
          shift: 'shift',
        };
        const mod = modMap[key];
        if (mod) {
          activeModifiers[mod] = false;
          updateKeyboardState();
          updateActivation();
        }
      });

      // Handle tooltip
      let tooltip = null;

      function showTooltip(key, event) {
        const keyName = standardizeKeyName(key.textContent);
        const shortcut = Object.entries(shortcuts).find(
          ([k, s]) =>
            k === keyName &&
            JSON.stringify(s.modifiers.sort()) ===
              JSON.stringify(
                Object.entries(activeModifiers)
                  .filter(([_, active]) => active)
                  .map(([mod]) => mod)
                  .sort(),
              ),
        );

        if (
          shortcut &&
          Object.entries(activeModifiers).filter(([_, active]) => active).length === shortcut[1].modifiers.length &&
          shortcut[1].modifiers.every((mod) =>
            Object.entries(activeModifiers)
              .filter(([_, active]) => active)
              .map(([mod]) => mod)
              .includes(mod),
          )
        ) {
          if (!tooltip) {
            tooltip = document.createElement('div');
            tooltip.className = 'action-tooltip';
            document.body.appendChild(tooltip);
          }

          tooltip.textContent = shortcut[1].action;
          tooltip.style.left = `${event.pageX + 10}px`;
          tooltip.style.top = `${event.pageY + 10}px`;
          tooltip.style.display = 'block';
        }
      }

      function hideTooltip() {
        if (tooltip) {
          tooltip.style.display = 'none';
        }
      }

      document.querySelectorAll('kbd').forEach((key) => {
        key.addEventListener('mouseover', (e) => showTooltip(key, e));
        key.addEventListener('mouseout', hideTooltip);
      });

      function createDagNode(type, label, modifiers = [], angle, level) {
        const node = document.createElement('kbd');
        node.textContent = label;

        if (modifiers.length > 1) {
          node.setAttribute('data-modifier-combo', modifiers.join(','));
        } else if (modifiers.length === 1) {
          node.setAttribute('data-modifier', modifiers[0]);
        } else if (type === 'context') {
          node.className = 'context';
        }

        // Store modifiers and type for activation logic
        if (modifiers.length > 0) {
          node.setAttribute('data-modifiers', JSON.stringify(modifiers));
        }
        node.setAttribute('data-node-type', type);

        // Adjust radius based on node type
        let radius;
        if (type === 'context') {
          radius = 0;
        } else {
          // All other nodes are placed at the same radius
          radius = 150;
        }

        const x = Math.cos(angle) * radius + 400;
        const y = Math.sin(angle) * radius + 400;

        node.style.left = `${x}px`;
        node.style.top = `${y}px`;

        return { node, x, y };
      }

      function createDagLink(x1, y1, x2, y2, modifiers = []) {
        const link = document.createElement('div');
        link.className = 'dag-link';
        if (modifiers.length > 0) {
          link.setAttribute('data-modifiers', JSON.stringify(modifiers));
        }

        const dx = x2 - x1;
        const dy = y2 - y1;
        const length = Math.sqrt(dx * dx + dy * dy);
        const angle = (Math.atan2(dy, dx) * 180) / Math.PI;

        link.style.width = `${length}px`;
        link.style.left = `${x1}px`;
        link.style.top = `${y1}px`;
        link.style.transform = `rotate(${angle}deg)`;

        return link;
      }

      function getModifierColor(modifier) {
        const colors = {
          cmd: '#00a67e',
          shift: '#e63946',
          alt: '#4361ee',
          ctrl: '#9d4edd',
        };
        return colors[modifier];
      }

      function updateDagView() {
        const container = document.querySelector('.dag-view .dag-container');
        container.innerHTML = '';

        // Add context node
        const contextNode = createDagNode('context', 'ctx', [], 0, 0);
        container.appendChild(contextNode.node);

        // First, organize the shortcuts into a tree structure
        const tree = {
          modifiers: new Map(), // Map of modifier -> { children: [], leaves: 0 }
          combos: new Map(), // Map of combo -> { children: [], leaves: 0 }
          direct: new Set(), // Set of shortcuts with no modifiers
        };

        // Count leaves and organize nodes
        Object.entries(shortcuts).forEach(([key, data]) => {
          if (data.modifiers.length === 0) {
            tree.direct.add(key);
          } else if (data.modifiers.length === 1) {
            if (!tree.modifiers.has(data.modifiers[0])) {
              tree.modifiers.set(data.modifiers[0], { children: [], leaves: 0 });
            }
            tree.modifiers.get(data.modifiers[0]).children.push(key);
            tree.modifiers.get(data.modifiers[0]).leaves++;
          } else if (data.modifiers.length > 1) {
            const comboKey = data.modifiers.sort().join('-');
            if (!tree.combos.has(comboKey)) {
              tree.combos.set(comboKey, { children: [], leaves: 0 });
            }
            tree.combos.get(comboKey).children.push(key);
            tree.combos.get(comboKey).leaves++;
          }
        });

        // Calculate total leaves for angle distribution
        const totalLeaves =
          Array.from(tree.modifiers.values()).reduce((sum, mod) => sum + mod.leaves, 0) +
          Array.from(tree.combos.values()).reduce((sum, combo) => sum + combo.leaves, 0) +
          tree.direct.size;

        // Place nodes using radial algorithm
        let currentAngle = 0;
        const TWO_PI = 2 * Math.PI;
        const baseRadius = 200;
        const actionRadius = 350;

        // Helper function to place nodes in an arc
        function placeNodesInArc(startAngle, angleSize, nodes, radius, parentX = 400, parentY = 400) {
          const angleStep = angleSize / (nodes.length || 1);
          return nodes.map((node, index) => {
            const angle = startAngle + angleStep * (index + 0.5);
            const x = Math.cos(angle) * radius + 400;
            const y = Math.sin(angle) * radius + 400;
            return { node, x, y, angle };
          });
        }

        // Place direct shortcuts at the action radius instead of base radius
        const directAngleSize = (tree.direct.size / totalLeaves) * TWO_PI;
        placeNodesInArc(currentAngle, directAngleSize, Array.from(tree.direct), actionRadius).forEach(
          ({ node, x, y }) => {
            const nodeEl = createDagNode('action', node, [], 0, 1);
            nodeEl.node.style.left = `${x}px`;
            nodeEl.node.style.top = `${y}px`;
            container.appendChild(nodeEl.node);
            // Link directly from context node to action
            container.appendChild(createDagLink(400, 400, x, y, []));
          },
        );
        currentAngle += directAngleSize;

        // Place modifier nodes and their children
        tree.modifiers.forEach((data, modifier) => {
          const modAngleSize = (data.leaves / totalLeaves) * TWO_PI;

          // Place modifier node
          const modX = Math.cos(currentAngle + modAngleSize / 2) * baseRadius + 400;
          const modY = Math.sin(currentAngle + modAngleSize / 2) * baseRadius + 400;
          const modNode = createDagNode('modifier', modifier, [modifier], 0, 1);
          modNode.node.style.left = `${modX}px`;
          modNode.node.style.top = `${modY}px`;
          container.appendChild(modNode.node);
          container.appendChild(createDagLink(400, 400, modX, modY, [modifier]));

          // Place children
          placeNodesInArc(currentAngle, modAngleSize, data.children, actionRadius, modX, modY).forEach(
            ({ node, x, y }) => {
              const childNode = createDagNode('action', node, [modifier], 0, 2);
              childNode.node.style.left = `${x}px`;
              childNode.node.style.top = `${y}px`;
              container.appendChild(childNode.node);
              container.appendChild(createDagLink(modX, modY, x, y, [modifier]));
            },
          );

          currentAngle += modAngleSize;
        });

        // Place combo nodes and their children
        tree.combos.forEach((data, combo) => {
          const comboAngleSize = (data.leaves / totalLeaves) * TWO_PI;
          const modifiers = combo.split('-');

          // Place combo node
          const comboX = Math.cos(currentAngle + comboAngleSize / 2) * baseRadius + 400;
          const comboY = Math.sin(currentAngle + comboAngleSize / 2) * baseRadius + 400;
          const comboNode = createDagNode('combo', combo, modifiers, 0, 1);
          comboNode.node.style.left = `${comboX}px`;
          comboNode.node.style.top = `${comboY}px`;
          container.appendChild(comboNode.node);
          container.appendChild(createDagLink(400, 400, comboX, comboY, modifiers));

          // Place children
          placeNodesInArc(currentAngle, comboAngleSize, data.children, actionRadius, comboX, comboY).forEach(
            ({ node, x, y }) => {
              const childNode = createDagNode('action', node, modifiers, 0, 2);
              childNode.node.style.left = `${x}px`;
              childNode.node.style.top = `${y}px`;
              container.appendChild(childNode.node);
              container.appendChild(createDagLink(comboX, comboY, x, y, modifiers));
            },
          );

          currentAngle += comboAngleSize;
        });
      }

      function updateActivation() {
        const activeModifiersList = Object.entries(activeModifiers)
          .filter(([_, active]) => active)
          .map(([mod]) => mod);

        // Check if we're in a combo state (2 or more modifiers active)
        const isComboActive = activeModifiersList.length >= 2;

        // Handle modifier nodes in DAG view
        document.querySelectorAll('.dag-view kbd[data-modifier]').forEach((node) => {
          const modifier = node.getAttribute('data-modifier');
          const isActive = activeModifiers[modifier];

          // Only show color when the modifier is active AND we're not in a combo state
          if (isActive && !isComboActive) {
            applyModifierStyles(node, [modifier], true, false);
          } else {
            node.style.background = '#3a3a3a';
          }
        });

        // Handle other nodes
        document.querySelectorAll('.dag-view kbd:not([data-modifier])').forEach((node) => {
          if (node.getAttribute('data-node-type') === 'context') return;

          const nodeModifiers = node.hasAttribute('data-modifiers')
            ? JSON.parse(node.getAttribute('data-modifiers'))
            : [];
          const nodeType = node.getAttribute('data-node-type');

          // For combo nodes (nodes with multiple modifiers)
          if (nodeModifiers.length >= 2) {
            const isFullyActive = nodeModifiers.every((mod) => activeModifiersList.includes(mod));
            if (isFullyActive) {
              applyModifierStyles(node, nodeModifiers, true, false);
            } else {
              node.style.background = '#3a3a3a';
            }
          }
          // For single-modifier nodes
          else if (nodeModifiers.length === 1) {
            const isActive = nodeModifiers.every((mod) => activeModifiersList.includes(mod));
            if (isActive && !isComboActive) {
              applyModifierStyles(node, nodeModifiers, true, false);
            } else {
              node.style.background = '#3a3a3a';
            }
          }
        });

        // Update links with similar logic
        document.querySelectorAll('.dag-link').forEach((link) => {
          const linkModifiers = link.hasAttribute('data-modifiers')
            ? JSON.parse(link.getAttribute('data-modifiers'))
            : [];

          // For combo links (links with multiple modifiers)
          if (linkModifiers.length >= 2) {
            const isFullyActive = linkModifiers.every((mod) => activeModifiersList.includes(mod));
            if (isFullyActive) {
              applyModifierStyles(link, linkModifiers, true, false);
              link.classList.add('active');
              link.classList.remove('partially-active');
            } else {
              link.style.background = '#3a3a3a';
              link.classList.remove('active', 'partially-active');
            }
          }
          // For single-modifier links
          else if (linkModifiers.length === 1) {
            const isActive = linkModifiers.every((mod) => activeModifiersList.includes(mod));
            if (isActive && !isComboActive) {
              applyModifierStyles(link, linkModifiers, true, false);
              link.classList.add('active');
              link.classList.remove('partially-active');
            } else {
              link.style.background = '#3a3a3a';
              link.classList.remove('active', 'partially-active');
            }
          }
        });
      }

      function getActiveModifiers() {
        return Object.entries(activeModifiers)
          .filter(([_, active]) => active)
          .map(([mod]) => mod);
      }

      // Hook up the activation logic to the existing keyboard events
      document.addEventListener('keydown', (e) => {
        console.log('Keydown:', e.key);
        const key = e.key.toLowerCase();
        // Map common key names to our modifier names
        const modMap = {
          control: 'ctrl',
          meta: 'cmd',
          alt: 'alt',
          shift: 'shift',
        };
        const mod = modMap[key];
        console.log('Mapped to modifier:', mod);
        if (mod) {
          activeModifiers[mod] = true;
          updateKeyboardState();
          updateActivation();
        }
      });

      document.addEventListener('keyup', (e) => {
        const key = e.key.toLowerCase();
        const modMap = {
          control: 'ctrl',
          meta: 'cmd',
          alt: 'alt',
          shift: 'shift',
        };
        const mod = modMap[key];
        if (mod) {
          activeModifiers[mod] = false;
          updateKeyboardState();
          updateActivation();
        }
      });

      // Handle clicks on modifier keys
      document.querySelectorAll('kbd[data-modifier]').forEach((key) => {
        key.addEventListener('click', () => {
          const mod = key.getAttribute('data-modifier');
          activeModifiers[mod] = !activeModifiers[mod];
          updateKeyboardState();
          updateActivation();
        });
      });

      // Toggle view functionality
      const toggleButton = document.querySelector('.view-toggle');
      const keyboardView = document.querySelector('.keyboard-view');
      const dagView = document.querySelector('.dag-view');

      toggleButton.addEventListener('click', () => {
        keyboardView.classList.toggle('active');
        dagView.classList.toggle('active');
        if (dagView.classList.contains('active')) {
          updateDagView();
        }
      });

      // Initial keyboard state update
      updateKeyboardState();

      // Call updateKeyboardState on initial load
      document.addEventListener('DOMContentLoaded', () => {
        updateKeyboardState();
        if (document.querySelector('.dag-view.active')) {
          updateActivation([]);
        }
      });
    </script>
  </body>
</html>
