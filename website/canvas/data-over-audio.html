<!doctype html>
<html lang="en-us">
  <head>
    <title>Data over Audio</title>
    <style>
      * {
        box-sizing: border-box;
      }

      html {
        width: 100%;
        height: 100%;
        position: fixed;
        overflow: hidden;
      }

      body {
        min-height: 100%;
        position: relative;
        margin: 0;
        font-family: Arial, sans-serif;
      }

      folk-shape {
        background: rgb(248, 248, 248);
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        padding: 12px;
      }

      .info-panel {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: transparent;
        padding: 20px 25px;
        text-align: center;
        font-size: 14px;
        border-radius: 8px;
        border: 1px solid #e0e0e0;
        max-width: 80%;
      }

      .info-title {
        font-size: 20px;
        font-weight: bold;
        margin-bottom: 12px;
        color: #333;
      }

      .warning {
        color: #ff5722;
        font-weight: bold;
        display: block;
        margin-top: 12px;
        font-size: 16px;
      }

      textarea {
        width: 100%;
        border-radius: 4px;
        border: 1px solid #ddd;
        padding: 8px;
        margin-bottom: 8px;
      }

      button {
        padding: 6px 12px;
        background-color: #4caf50;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }

      button:hover {
        background-color: #45a049;
      }

      h3 {
        margin-top: 0;
        margin-bottom: 8px;
        color: #333;
        font-size: 16px;
      }

      #spectrogram-canvas {
        width: 100%;
        height: 300px;
        background-color: #000;
        border-radius: 4px;
        display: block;
      }
    </style>
  </head>
  <body>
    <div class="info-panel">
      <div class="info-title">data over audio</div>
      <p
        >Use your speaker and microphone to send and receive data between 2 or more devices with
        <a href="https://github.com/ggerganov/ggwave">ggwave</a>.</p
      >
      <span class="warning">Volume can be loud!</span>
    </div>

    <!-- Sender Shape -->
    <folk-shape x="50" y="50" width="300" height="200">
      <h3>Send Data</h3>
      <textarea id="txData" style="height: 100px">Hello from Folk Canvas!</textarea>
      <button onclick="onSend();">Send via Audio</button>
    </folk-shape>

    <!-- Receiver Shape -->
    <folk-shape x="400" y="50" width="300" height="200">
      <h3>Receive Data</h3>
      <textarea id="rxData" style="height: 100px" disabled></textarea>
      <div style="display: flex; gap: 8px">
        <button id="captureStart">Start Listening</button>
        <button id="captureStop" hidden>Stop</button>
      </div>
    </folk-shape>

    <!-- Spectrogram Shape -->
    <folk-shape x="50" y="280" width="650" height="350">
      <h3>Audio Spectrogram</h3>
      <canvas id="spectrogram-canvas"></canvas>
    </folk-shape>

    <script type="module">
      import '@labs/standalone/folk-shape.ts';
    </script>

    <script type="text/javascript" src="/ggwave.js"></script>
    <script type="text/javascript">
      window.AudioContext = window.AudioContext || window.webkitAudioContext;
      window.OfflineAudioContext = window.OfflineAudioContext || window.webkitOfflineAudioContext;

      var context = null;
      var recorder = null;
      var mediaStream = null;
      var analyser = null;
      var spectrogramAnimationId = null;

      var ggwave = null;
      var parameters = null;
      var instance = null;

      ggwave_factory().then(function (obj) {
        ggwave = obj;
      });

      var txData = document.getElementById('txData');
      var rxData = document.getElementById('rxData');
      var captureStart = document.getElementById('captureStart');
      var captureStop = document.getElementById('captureStop');
      var spectrogramCanvas = document.getElementById('spectrogram-canvas');
      var spectrogramCtx = spectrogramCanvas.getContext('2d');

      // Initialize the canvas size properly
      function resizeCanvas() {
        if (spectrogramCanvas) {
          spectrogramCanvas.width = spectrogramCanvas.parentElement.clientWidth - 24; // Account for padding
          spectrogramCanvas.height = 300; // Increased from 150 to 300 for more vertical detail

          // Clear the canvas with black background
          spectrogramCtx.fillStyle = 'black';
          spectrogramCtx.fillRect(0, 0, spectrogramCanvas.width, spectrogramCanvas.height);

          // Draw frequency scale on the right side
          drawFrequencyScale();
        }
      }

      // Draw frequency scale on the right side of the canvas
      function drawFrequencyScale() {
        var height = spectrogramCanvas.height;
        var width = spectrogramCanvas.width;

        spectrogramCtx.fillStyle = 'rgba(0, 0, 0, 0.5)';
        spectrogramCtx.fillRect(width - 40, 0, 40, height);

        spectrogramCtx.fillStyle = 'white';
        spectrogramCtx.font = '10px Arial';
        spectrogramCtx.textAlign = 'right';

        // Draw frequency markers
        var maxFreq = context ? context.sampleRate / 2 : 24000; // Nyquist frequency
        var step = height / 10;

        for (var i = 0; i <= 10; i++) {
          var y = height - i * step;
          var freq = (i / 10) * maxFreq;

          // Format frequency display
          var freqText = freq >= 1000 ? (freq / 1000).toFixed(1) + ' kHz' : freq.toFixed(0) + ' Hz';

          // Draw tick mark
          spectrogramCtx.fillRect(width - 35, y, 5, 1);

          // Draw text
          spectrogramCtx.fillText(freqText, width - 8, y + 3);
        }
      }

      // Initialize on page load
      window.addEventListener('load', function () {
        init();
        resizeCanvas();
      });

      // Handle window resize
      window.addEventListener('resize', resizeCanvas);

      function convertTypedArray(src, type) {
        var buffer = new ArrayBuffer(src.byteLength);
        var baseView = new src.constructor(buffer).set(src);
        return new type(buffer);
      }

      function init() {
        if (!context) {
          context = new AudioContext({ sampleRate: 48000 });
          parameters = ggwave.getDefaultParameters();
          parameters.sampleRateInp = context.sampleRate;
          parameters.sampleRateOut = context.sampleRate;
          instance = ggwave.init(parameters);
        }
      }

      // Custom spectrogram visualization
      function drawSpectrogram() {
        if (!analyser) return;

        // Get frequency data
        var fftSize = analyser.frequencyBinCount;
        var dataArray = new Uint8Array(fftSize);
        analyser.getByteFrequencyData(dataArray);

        // Shift the existing spectrogram to the left
        var imageData = spectrogramCtx.getImageData(1, 0, spectrogramCanvas.width - 41, spectrogramCanvas.height);
        spectrogramCtx.putImageData(imageData, 0, 0);

        // Clear the right edge where we'll draw new data
        spectrogramCtx.fillStyle = 'black';
        spectrogramCtx.fillRect(spectrogramCanvas.width - 41, 0, 1, spectrogramCanvas.height);

        // Draw the new column of frequency data
        for (var i = 0; i < fftSize; i++) {
          // Map the frequency data (0-255) to a color
          var value = dataArray[i];

          // Skip very low values for cleaner visualization
          if (value < 5) continue;

          // Create a vibrant color gradient
          var intensity = value / 255;

          // HSL color model for more vibrant colors
          var hue = 240 - intensity * 240; // Blue to red
          var saturation = 100;
          var lightness = 50;

          // Adjust lightness based on intensity for better contrast
          if (intensity > 0.8) {
            lightness = 60 + (intensity - 0.8) * 40; // Brighter for high intensities
          } else if (intensity < 0.2) {
            lightness = 30 + intensity * 100; // Darker for low intensities
          }

          spectrogramCtx.fillStyle = 'hsl(' + hue + ', ' + saturation + '%, ' + lightness + '%)';

          // Calculate y position - map frequency bin to canvas height
          var y = spectrogramCanvas.height - Math.round((i / fftSize) * spectrogramCanvas.height);

          // Draw a line instead of a pixel for better visibility
          var lineHeight = Math.max(1, Math.round(spectrogramCanvas.height / fftSize) + 1);
          spectrogramCtx.fillRect(spectrogramCanvas.width - 41, y - lineHeight / 2, 1, lineHeight);
        }

        // Continue animation
        spectrogramAnimationId = requestAnimationFrame(drawSpectrogram);
      }

      // Start the spectrogram visualization
      function startSpectrogram() {
        if (spectrogramAnimationId) {
          cancelAnimationFrame(spectrogramAnimationId);
        }

        // Clear the canvas
        spectrogramCtx.fillStyle = 'black';
        spectrogramCtx.fillRect(0, 0, spectrogramCanvas.width, spectrogramCanvas.height);

        // Start the animation
        spectrogramAnimationId = requestAnimationFrame(drawSpectrogram);
      }

      // Stop the spectrogram visualization
      function stopSpectrogram() {
        if (spectrogramAnimationId) {
          cancelAnimationFrame(spectrogramAnimationId);
          spectrogramAnimationId = null;
        }
      }

      function onSend() {
        init();
        captureStop.click();

        var waveform = ggwave.encode(instance, txData.value, ggwave.ProtocolId.GGWAVE_PROTOCOL_AUDIBLE_FASTEST, 10);
        var buf = convertTypedArray(waveform, Float32Array);
        var buffer = context.createBuffer(1, buf.length, context.sampleRate);
        buffer.getChannelData(0).set(buf);
        var source = context.createBufferSource();
        source.buffer = buffer;

        // Create analyzer for visualization
        analyser = context.createAnalyser();
        analyser.fftSize = 2048; // Increased from 256 to 2048 for higher resolution
        analyser.smoothingTimeConstant = 0.3; // Reduced from 0.5 for more responsiveness
        analyser.minDecibels = -90;
        analyser.maxDecibels = -10; // Increased from -30 for better dynamic range

        source.connect(analyser);
        source.connect(context.destination);

        // Start visualization
        startSpectrogram();

        source.start(0);

        // Stop visualization after the audio is done
        source.onended = function () {
          stopSpectrogram();
        };
      }

      captureStart.addEventListener('click', function () {
        init();
        resizeCanvas();

        navigator.mediaDevices
          .getUserMedia({
            audio: {
              echoCancellation: false,
              autoGainControl: false,
              noiseSuppression: false,
            },
          })
          .then(function (stream) {
            mediaStream = context.createMediaStreamSource(stream);

            // Create analyzer node for spectrogram
            analyser = context.createAnalyser();
            analyser.fftSize = 2048; // Increased from 256 to 2048 for higher resolution
            analyser.smoothingTimeConstant = 0.3; // Reduced from 0.5 for more responsiveness
            analyser.minDecibels = -90;
            analyser.maxDecibels = -10; // Increased from -30 for better dynamic range
            mediaStream.connect(analyser);

            // Start the spectrogram visualization
            startSpectrogram();

            var bufferSize = 1024;
            recorder = context.createScriptProcessor(bufferSize, 1, 1);

            recorder.onaudioprocess = function (e) {
              var source = e.inputBuffer;
              var res = ggwave.decode(
                instance,
                convertTypedArray(new Float32Array(source.getChannelData(0)), Int8Array),
              );

              if (res && res.length > 0) {
                rxData.value = new TextDecoder('utf-8').decode(res);
              }
            };

            mediaStream.connect(recorder);
            recorder.connect(context.destination);
          })
          .catch(function (e) {
            console.error(e);

            // Show error message on canvas
            spectrogramCtx.fillStyle = 'white';
            spectrogramCtx.font = '14px Arial';
            spectrogramCtx.textAlign = 'center';
            spectrogramCtx.fillText(
              'Error accessing microphone: ' + e.message,
              spectrogramCanvas.width / 2,
              spectrogramCanvas.height / 2,
            );
          });

        rxData.value = 'Listening...';
        captureStart.hidden = true;
        captureStop.hidden = false;
      });

      captureStop.addEventListener('click', function () {
        if (recorder) {
          recorder.disconnect(context.destination);
          mediaStream.disconnect(recorder);
          recorder = null;
        }

        if (analyser && mediaStream) {
          mediaStream.disconnect(analyser);
        }

        // Stop the spectrogram visualization
        stopSpectrogram();

        rxData.value = '';
        captureStart.hidden = false;
        captureStop.hidden = true;
      });

      captureStop.click();
    </script>
  </body>
</html>
