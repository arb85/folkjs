<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Folk Canvas Benchmarks</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon"></script>
  </head>
  <body>
    <h1>Folk Canvas Benchmarks</h1>

    <div>
      <label for="package-select">Package:</label>
      <select id="package-select"></select>

      <label for="benchmark-select">Benchmark:</label>
      <select id="benchmark-select"></select>
    </div>

    <div style="width: 800px; height: 400px">
      <canvas id="benchmark-chart"></canvas>
    </div>

    <script>
      async function fetchBenchmarkData() {
        const response = await fetch(
          'https://raw.githubusercontent.com/folk-systems/folk-canvas-stats/main/mitata_benchmarks.json',
        );
        return await response.json();
      }

      function processData(data) {
        // Get unique packages and benchmarks
        const packages = new Set();
        const benchmarks = new Set();

        Object.values(data).forEach((commit) => {
          Object.keys(commit.packages).forEach((pkg) => {
            packages.add(pkg);
            Object.keys(commit.packages[pkg]).forEach((bench) => {
              benchmarks.add(bench);
            });
          });
        });

        return {
          packages: Array.from(packages),
          benchmarks: Array.from(benchmarks),
          data,
        };
      }

      function updateChart(data, selectedPackage, selectedBenchmark) {
        const commits = Object.entries(data).sort(([, a], [, b]) => new Date(a.timestamp) - new Date(b.timestamp));

        const chartData = commits
          .map(([commit, info]) => ({
            x: new Date(info.timestamp),
            y: info.packages[selectedPackage]?.[selectedBenchmark]?.results[0]?.avg || null,
          }))
          .filter((point) => point.y !== null);

        const ctx = document.getElementById('benchmark-chart');
        if (window.benchmarkChart) {
          window.benchmarkChart.destroy();
        }

        window.benchmarkChart = new Chart(ctx, {
          type: 'line',
          data: {
            datasets: [
              {
                label: `${selectedPackage} - ${selectedBenchmark}`,
                data: chartData,
                borderColor: 'rgb(75, 192, 192)',
                tension: 0.1,
              },
            ],
          },
          options: {
            responsive: true,
            scales: {
              x: {
                type: 'time',
                time: {
                  unit: 'day',
                },
              },
              y: {
                title: {
                  display: true,
                  text: 'Average Time (ns)',
                },
              },
            },
          },
        });
      }

      async function initialize() {
        const rawData = await fetchBenchmarkData();
        const { packages, benchmarks, data } = processData(rawData);

        // Populate selects
        const packageSelect = document.getElementById('package-select');
        const benchmarkSelect = document.getElementById('benchmark-select');

        packages.forEach((pkg) => {
          const option = document.createElement('option');
          option.value = pkg;
          option.textContent = pkg;
          packageSelect.appendChild(option);
        });

        benchmarks.forEach((bench) => {
          const option = document.createElement('option');
          option.value = bench;
          option.textContent = bench;
          benchmarkSelect.appendChild(option);
        });

        // Initial chart
        updateChart(data, packages[0], benchmarks[0]);

        // Handle selection changes
        packageSelect.addEventListener('change', () => {
          updateChart(data, packageSelect.value, benchmarkSelect.value);
        });

        benchmarkSelect.addEventListener('change', () => {
          updateChart(data, packageSelect.value, benchmarkSelect.value);
        });
      }

      initialize().catch(console.error);
    </script>
  </body>
</html>
